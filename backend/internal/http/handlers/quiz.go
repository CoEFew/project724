package handlers

import (
	"crypto/hmac"
	crand "crypto/rand" // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏ö‡∏ï‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
	"crypto/sha256"
	"encoding/base64"
	"encoding/hex"
	"encoding/json"
	"math/rand"
	"net/http"
	"os"
	"strconv"
	"strings"
	"time"
)

// ==== (1) Data & Config ====

type QuizResp struct {
	ID    string   `json:"id"`
	Hints []string `json:"hints"`
	Token string   `json:"token"` // HMAC(secret, answer|id|exp)
	Exp   int64    `json:"exp"`   // unix seconds
}

type QA struct {
	Answer string
	Hints  []string
}

// -------- Level 1 (‡∏ä‡∏∏‡∏î‡∏á‡πà‡∏≤‡∏¢ - ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) --------
var quizzesEasy = []QA{
	{"‡πÅ‡∏°‡∏ß", []string{"‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß", "‡∏°‡∏µ‡∏´‡∏ô‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô‡∏õ‡∏•‡∏≤"}},
	{"‡∏´‡∏°‡∏≤", []string{"‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πà‡∏≤", "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå"}},
	{"‡∏ä‡πâ‡∏≤‡∏á", []string{"‡∏°‡∏µ‡∏á‡∏ß‡∏á", "‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏á‡∏≤"}},
	{"‡∏°‡πâ‡∏≤", []string{"‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß", "‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á"}},
	{"‡∏ß‡∏±‡∏ß", []string{"‡πÉ‡∏´‡πâ‡∏ô‡∏°", "‡∏°‡∏µ‡πÄ‡∏Ç‡∏≤"}},
	{"‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", []string{"‡∏´‡∏π‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢", "‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó"}},
	{"‡πÄ‡∏™‡∏∑‡∏≠", []string{"‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤", "‡∏•‡∏≤‡∏¢‡∏™‡∏ß‡∏¢"}},
	{"‡∏™‡∏¥‡∏á‡πÇ‡∏ï", []string{"‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡πà‡∏≤", "‡∏°‡∏µ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏≠"}},
	{"‡πÅ‡∏û‡∏ô‡∏î‡πâ‡∏≤", []string{"‡∏Å‡∏¥‡∏ô‡πÑ‡∏ú‡πà", "‡∏ï‡∏±‡∏ß‡∏≠‡πâ‡∏ß‡∏ô‡∏Å‡∏•‡∏°"}},
	{"‡πÇ‡∏Ñ‡∏≠‡∏≤‡∏•‡πà‡∏≤", []string{"‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ", "‡∏ä‡∏≠‡∏ö‡∏Å‡∏≠‡∏î‡∏ï‡πâ‡∏ô‡∏¢‡∏π‡∏Ñ‡∏≤‡∏•‡∏¥‡∏õ‡∏ï‡∏±‡∏™"}},
	{"‡∏ô‡∏Å", []string{"‡∏ö‡∏¥‡∏ô‡πÑ‡∏î‡πâ", "‡∏°‡∏µ‡∏õ‡∏µ‡∏Å"}},
	{"‡πÑ‡∏Å‡πà", []string{"‡∏Ç‡∏±‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤", "‡∏°‡∏µ‡∏´‡∏á‡∏≠‡∏ô"}},
	{"‡πÄ‡∏õ‡πá‡∏î", []string{"‡πÄ‡∏î‡∏¥‡∏ô‡πÇ‡∏¢‡∏Å‡πÄ‡∏¢‡∏Å", "‡∏£‡πâ‡∏≠‡∏á‡∏Å‡πä‡∏≤‡∏ö‡πÜ"}},
	{"‡∏ô‡∏Å‡∏¢‡∏π‡∏á", []string{"‡∏´‡∏≤‡∏á‡∏™‡∏ß‡∏¢", "‡∏ä‡∏≠‡∏ö‡∏£‡∏≥‡πÅ‡∏û‡∏ô‡∏´‡∏≤‡∏á"}},
	{"‡∏Å‡∏ö", []string{"‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÑ‡∏î‡πâ", "‡∏£‡πâ‡∏≠‡∏á‡∏≠‡πä‡∏ö‡πÜ"}},
	{"‡∏á‡∏π", []string{"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≤", "‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡πÑ‡∏î‡πâ"}},
	{"‡πÄ‡∏ï‡πà‡∏≤", []string{"‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡πâ‡∏≤", "‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡πá‡∏á"}},
	{"‡∏°‡∏î", []string{"‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å", "‡∏Ç‡∏¢‡∏±‡∏ô"}},
	{"‡∏ú‡∏∂‡πâ‡∏á", []string{"‡∏ó‡∏≥‡∏£‡∏±‡∏á", "‡∏°‡∏µ‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÉ‡∏ô"}},
	{"‡∏¢‡∏∏‡∏á", []string{"‡∏î‡∏π‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "‡∏ö‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á"}},
	{"‡πÅ‡∏°‡∏•‡∏á‡∏õ‡∏≠", []string{"‡∏ö‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß", "‡∏ï‡∏≤‡πÇ‡∏ï"}},
	{"‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏á", []string{"‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÉ‡∏ô‡∏ï‡∏π‡πâ", "‡∏™‡∏µ‡∏ó‡∏≠‡∏á"}},
	{"‡∏õ‡∏•‡∏≤‡∏ó‡∏π", []string{"‡∏´‡∏±‡∏ß‡πÇ‡∏ï", "‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏≥‡∏ï‡πâ‡∏°‡∏¢‡∏≥"}},
	{"‡∏õ‡∏•‡∏≤‡∏ô‡∏¥‡∏•", []string{"‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏á‡πà‡∏≤‡∏¢", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏≠‡∏£‡πà‡∏≠‡∏¢"}},
	{"‡∏õ‡∏•‡∏≤‡∏â‡∏•‡∏≤‡∏°", []string{"‡∏ü‡∏±‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏Ñ‡∏°", "‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•"}},
	{"‡πÇ‡∏•‡∏°‡∏≤", []string{"‡∏â‡∏•‡∏≤‡∏î", "‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ô‡πâ‡∏≥"}},
	{"‡∏õ‡∏•‡∏≤‡∏ß‡∏≤‡∏¨", []string{"‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏∞‡πÄ‡∏•", "‡∏û‡πà‡∏ô‡∏ô‡πâ‡∏≥"}},
	{"‡∏õ‡∏π", []string{"‡πÄ‡∏î‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏á", "‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡∏ö"}},
	{"‡∏Å‡∏∏‡πâ‡∏á", []string{"‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡πá‡∏á", "‡∏°‡∏µ‡∏´‡∏ô‡∏ß‡∏î"}},
	{"‡∏´‡∏≠‡∏¢", []string{"‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡πâ‡∏≥"}},
	{"‡∏´‡∏°‡∏π", []string{"‡∏ä‡∏≠‡∏ö‡∏Å‡∏•‡∏¥‡πâ‡∏á‡πÇ‡∏Ñ‡∏•‡∏ô", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ô‡∏¥‡∏¢‡∏°‡∏Å‡∏¥‡∏ô"}},
	{"‡πÅ‡∏û‡∏∞", []string{"‡πÄ‡∏Ç‡∏≤‡πÇ‡∏Ñ‡πâ‡∏á", "‡∏Å‡∏¥‡∏ô‡∏´‡∏ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÑ‡∏°‡πâ"}},
	{"‡πÅ‡∏Å‡∏∞", []string{"‡∏°‡∏µ‡∏Ç‡∏ô‡∏´‡∏ô‡∏≤", "‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤"}},
	{"‡∏•‡∏¥‡∏á", []string{"‡∏õ‡∏µ‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏Å‡πà‡∏á", "‡∏ä‡∏≠‡∏ö‡∏Å‡∏•‡πâ‡∏ß‡∏¢"}},
	{"‡∏Å‡∏ß‡∏≤‡∏á", []string{"‡∏°‡∏µ‡πÄ‡∏Ç‡∏≤‡∏á‡∏≤‡∏°", "‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏ß‡πÉ‡∏ô‡∏õ‡πà‡∏≤"}},
	{"‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å", []string{"‡∏´‡∏≤‡∏á‡∏ü‡∏π", "‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏´‡πå‡πÉ‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô"}},
	{"‡∏´‡∏°‡∏≤‡∏õ‡πà‡∏≤", []string{"‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡∏π‡∏á", "‡∏´‡∏≠‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á"}},
	{"‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ß", []string{"‡∏ö‡∏¥‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô", "‡∏´‡πâ‡∏≠‡∏¢‡∏´‡∏±‡∏ß‡∏ô‡∏≠‡∏ô"}},
	{"‡∏Å‡∏£‡∏∞‡∏£‡∏≠‡∏Å", []string{"‡∏´‡∏≤‡∏á‡∏ü‡∏π", "‡∏ä‡∏≠‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡∏±‡πà‡∏ß"}},
	{"‡πÄ‡∏°‡πà‡∏ô", []string{"‡∏°‡∏µ‡∏´‡∏ô‡∏≤‡∏°‡πÅ‡∏´‡∏•‡∏°", "‡∏°‡πâ‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ"}},
	{"‡∏¢‡∏µ‡∏£‡∏≤‡∏ü", []string{"‡∏Ñ‡∏≠‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å", "‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á"}},
	{"‡∏°‡πâ‡∏≤‡∏•‡∏≤‡∏¢", []string{"‡∏•‡∏≤‡∏¢‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥", "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏ç‡πâ‡∏≤"}},
	{"‡πÅ‡∏£‡∏î", []string{"‡∏°‡∏µ‡∏ô‡∏≠‡πÉ‡∏´‡∏ç‡πà", "‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡πÅ‡∏£‡∏á‡πÄ‡∏¢‡∏≠‡∏∞"}},
	{"‡∏Æ‡∏¥‡∏õ‡πÇ‡∏õ", []string{"‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥", "‡∏õ‡∏≤‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å"}},
	{"‡∏à‡∏¥‡∏á‡πÇ‡∏à‡πâ", []string{"‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏£‡πá‡∏ß"}},
	{"‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å", []string{"‡∏ï‡∏≤‡πÇ‡∏ï", "‡∏ï‡∏∑‡πà‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô"}},
}

// -------- Level 2+ (‡∏ä‡∏∏‡∏î‡∏¢‡∏≤‡∏Å - ‡πÉ‡∏´‡∏°‡πà 30 ‡∏Ñ‡∏≥) --------
var quizzesHard = []QA{
	{"‡πÄ‡∏•‡∏µ‡∏¢‡∏á‡∏ú‡∏≤", []string{"‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏™‡∏π‡∏á‡∏ú‡∏≤‡∏ä‡∏±‡∏ô", "‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÄ‡∏´‡∏ß‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡πà‡∏≠‡∏á"}},
	{"‡∏•‡∏∞‡∏°‡∏±‡πà‡∏á", []string{"‡∏Å‡∏ß‡∏≤‡∏á‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢", "‡πÄ‡∏Ç‡∏≤‡πÇ‡∏Ñ‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ß‡∏á‡∏≤‡∏°"}},
	{"‡πÄ‡∏Å‡πâ‡∏á", []string{"‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å", "‡∏ö‡∏≤‡∏á‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏´‡πà‡∏≤"}},
	{"‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á", []string{"‡∏ß‡∏±‡∏ß‡∏õ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà", "‡πÄ‡∏Ç‡∏≤‡∏î‡∏≥‡πÇ‡∏Ñ‡πâ‡∏á‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á"}},
	{"‡∏™‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à", []string{"‡∏•‡∏≤‡∏¢‡∏Ç‡∏≤‡∏ß‡∏î‡∏≥", "‡∏à‡∏°‡∏π‡∏Å‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏á‡∏ß‡∏á"}},
	{"‡∏ä‡∏∞‡∏°‡∏î", []string{"‡∏ï‡πà‡∏≠‡∏°‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏≠‡∏°", "‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô"}},
	{"‡∏≠‡∏µ‡πÄ‡∏´‡πá‡∏ô", []string{"‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ä‡∏∞‡∏°‡∏î", "‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß"}},
	{"‡∏ô‡∏¥‡πà‡∏°", []string{"‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏ï‡∏±‡∏ß", "‡∏°‡πâ‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢"}},
	{"‡∏ô‡∏≤‡∏Å", []string{"‡∏Å‡∏∂‡πà‡∏á‡∏ö‡∏Å‡∏ô‡πâ‡∏≥", "‡∏ä‡∏≠‡∏ö‡∏à‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡πÄ‡∏•‡πà‡∏ô"}},
	{"‡πÄ‡∏™‡∏∑‡∏≠‡∏î‡∏≤‡∏ß", []string{"‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡πÇ‡∏£‡πÄ‡∏ã‡∏ï", "‡∏õ‡∏µ‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏Å‡πà‡∏á"}},
	{"‡πÄ‡∏™‡∏∑‡∏≠‡∏ä‡∏µ‡∏ï‡∏≤‡∏´‡πå", []string{"‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏ö‡∏Å", "‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏î‡∏≥"}},
	{"‡πÄ‡∏ü‡∏ô‡πÄ‡∏ô‡∏Å", []string{"‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏•‡∏ó‡∏£‡∏≤‡∏¢", "‡∏´‡∏π‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å"}},
	{"‡∏•‡∏≤‡∏°‡∏≤", []string{"‡∏ç‡∏≤‡∏ï‡∏¥‡∏≠‡∏±‡∏•‡∏õ‡∏≤‡∏Å‡∏≤", "‡∏ñ‡∏¥‡πà‡∏ô‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÅ‡∏≠‡∏ô‡∏î‡∏µ‡∏™"}},
	{"‡∏≠‡∏±‡∏•‡∏õ‡∏≤‡∏Å‡∏≤", []string{"‡∏Ç‡∏ô‡∏ü‡∏π‡∏ô‡∏∏‡πà‡∏°", "‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à‡∏ä‡∏≠‡∏ö‡∏û‡πà‡∏ô‡∏ô‡πâ‡∏≥‡∏•‡∏≤‡∏¢"}},
	{"‡πÑ‡∏Ñ‡πÅ‡∏°‡∏ô", []string{"‡∏ç‡∏≤‡∏ï‡∏¥‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å", "‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡πÄ‡∏°‡∏ã‡∏≠‡∏ô"}},
	{"‡πÇ‡∏≠‡∏Ñ‡∏≤‡∏õ‡∏¥", []string{"‡∏ç‡∏≤‡∏ï‡∏¥‡∏Å‡∏±‡∏ö‡∏¢‡∏µ‡∏£‡∏≤‡∏ü", "‡∏Ç‡∏≤‡∏•‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏°‡πâ‡∏≤‡∏•‡∏≤‡∏¢"}},
	{"‡πÑ‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏ã‡πå", []string{"‡πÅ‡∏û‡∏∞‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", "‡πÄ‡∏Ç‡∏≤‡∏¢‡∏≤‡∏ß‡∏ö‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏ß"}},
	{"‡∏ß‡∏≠‡∏°‡πÅ‡∏ö‡∏ï", []string{"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡πâ‡∏≠‡∏á", "‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°"}},
	{"‡πÇ‡∏Ñ‡∏≠‡∏≤‡∏ï‡∏¥", []string{"‡∏à‡∏°‡∏π‡∏Å‡∏¢‡∏≤‡∏ß‡πÇ‡∏Ñ‡πâ‡∏á", "‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏ß‡∏µ‡∏õ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤"}},
	{"‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏ö‡∏≤‡∏£‡∏≤", []string{"‡∏´‡∏ô‡∏π‡∏¢‡∏±‡∏Å‡∏©‡πå", "‡∏ä‡∏≠‡∏ö‡∏•‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏ä‡πà"}},
	{"‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏≤‡∏î‡∏¥‡∏•‡πÇ‡∏•", []string{"‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÅ‡∏Ç‡πá‡∏á", "‡∏°‡πâ‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏°"}},
	{"‡∏û‡∏¥‡∏£‡∏±‡∏ô‡∏¢‡∏≤", []string{"‡∏ü‡∏±‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏Ñ‡∏°", "‡∏´‡∏≤‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡∏π‡∏á"}},
	{"‡∏Ñ‡∏≤‡∏™‡πÇ‡∏ã‡∏ß‡∏≤‡∏£‡∏µ", []string{"‡∏ô‡∏Å‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏≠‡∏™‡∏µ‡∏ü‡πâ‡∏≤", "‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"}},
	{"‡∏Å‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≤‡πÉ‡∏ö‡πÑ‡∏°‡πâ", []string{"‡∏û‡∏£‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô", "‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ö‡πÑ‡∏°‡πâ"}},
	{"‡πÅ‡∏û‡∏ô‡πÄ‡∏ò‡∏≠‡∏£‡πå", []string{"‡πÄ‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏°‡∏•‡∏≤‡∏ô‡∏¥‡∏™‡∏ï‡∏¥‡∏Å", "‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà"}},
	{"‡∏Ñ‡∏π‡∏î‡∏π", []string{"‡πÄ‡∏Ç‡∏≤‡∏¢‡∏≤‡∏ß‡∏ö‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏ß", "‡∏≠‡∏±‡∏ü‡∏£‡∏¥‡∏Å‡∏≤"}},
	{"‡∏ä‡∏¥‡∏°‡πÅ‡∏õ‡∏ô‡∏ã‡∏µ", []string{"‡∏â‡∏•‡∏≤‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô"}},
	{"‡∏≠‡∏∏‡∏£‡∏±‡∏á‡∏≠‡∏∏‡∏ï‡∏±‡∏á", []string{"‡∏•‡∏¥‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏µ‡∏™‡πâ‡∏°", "‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ö‡πÑ‡∏°‡πâ"}},
	{"‡∏ß‡∏≤‡∏¨‡πÄ‡∏û‡∏ä‡∏å‡∏Ü‡∏≤‡∏ï", []string{"‡πÇ‡∏≠‡∏£‡πå‡∏Å‡πâ‡∏≤", "‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡∏ó‡∏∞‡πÄ‡∏•‡∏¢‡∏≠‡∏î‡∏ù‡∏µ‡∏°‡∏∑‡∏≠"}},
	{"‡∏Ñ‡∏ß‡∏≠‡∏Å‡∏Å‡∏≤", []string{"‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏¢‡∏¥‡πâ‡∏°", "‡πÄ‡∏Å‡∏≤‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢"}},
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
var quizzesByLevel = map[int][]QA{
	1: quizzesEasy,
	2: quizzesHard,
}

// ‡∏î‡∏∂‡∏á secret ‡∏à‡∏≤‡∏Å env (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏ô HMAC_SECRET=super-secret)
func getSecret() []byte {
	sec := os.Getenv("HMAC_SECRET")
	if sec == "" {
		sec = "change-me-in-env"
	}
	return []byte(sec)
}

// ‡∏™‡∏∏‡πà‡∏° id ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
func randomID() (string, error) {
	buf := make([]byte, 16)
	if _, err := crand.Read(buf); err != nil {
		return "", err
	}
	return hex.EncodeToString(buf), nil
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á HMAC(base64) ‡∏à‡∏≤‡∏Å s
func sign(secret []byte, s string) string {
	mac := hmac.New(sha256.New, secret)
	mac.Write([]byte(s))
	sum := mac.Sum(nil)
	return base64.StdEncoding.EncodeToString(sum)
}

// ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö HMAC
func equalHMAC(a, b string) bool {
	ab, _ := base64.StdEncoding.DecodeString(a)
	bb, _ := base64.StdEncoding.DecodeString(b)
	return hmac.Equal(ab, bb)
}

// ==== (2) Handlers ====

func poolForLevel(level int) []QA {
	// ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á: ‡πÉ‡∏ä‡πâ‡∏ä‡∏∏‡∏î‡∏¢‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà level >= 4
	tier := 1
	if level >= 4 {
		tier = 2
	}
	if p, ok := quizzesByLevel[tier]; ok && len(p) > 0 {
		return p
	}
	// fallback ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
	return quizzesEasy
}

func GetQuiz(w http.ResponseWriter, r *http.Request) {
	// ‡∏≠‡πà‡∏≤‡∏ô level ‡∏à‡∏≤‡∏Å query
	level := 1
	if lv := r.URL.Query().Get("level"); lv != "" {
		if n, err := strconv.Atoi(lv); err == nil && n > 0 {
			level = n
		}
	}

	// ‚úÖ ‡πÉ‡∏ä‡πâ quizzesByLevel ‡∏ú‡πà‡∏≤‡∏ô helper
	pool := poolForLevel(level)

	// ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å pool
	now := time.Now()
	rand.Seed(now.UnixNano())
	idx := rand.Intn(len(pool))
	q := pool[idx]

	// ‡∏ó‡∏≥ id/token/exp ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°...
	id, err := randomID()
	if err != nil {
		http.Error(w, "cannot generate id", http.StatusInternalServerError)
		return
	}
	exp := now.Add(60 * time.Second).Unix()

	secret := getSecret()
	payload := q.Answer + "|" + id + "|" + strconvFormatInt(exp)
	token := sign(secret, payload)

	resp := QuizResp{
		ID:    id,
		Hints: q.Hints,
		Token: token,
		Exp:   exp,
	}
	w.Header().Set("Content-Type", "application/json")
	_ = json.NewEncoder(w).Encode(resp)
}

type CheckReq struct {
	ID    string `json:"id"`
	Guess string `json:"guess"`
	Token string `json:"token"`
	Exp   int64  `json:"exp"`
}

func CheckQuiz(w http.ResponseWriter, r *http.Request) {
	var req CheckReq
	if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
		http.Error(w, "bad request", http.StatusBadRequest)
		return
	}

	// ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏?
	if time.Now().Unix() > req.Exp {
		w.Header().Set("Content-Type", "application/json")
		_ = json.NewEncoder(w).Encode(map[string]any{"correct": false, "reason": "expired"})
		return
	}

	// ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö HMAC(secret, guess|id|exp) ‡∏Å‡∏±‡∏ö token
	secret := getSecret()
	normalizedGuess := normalizeThai(req.Guess)
	signGuess := sign(secret, normalizedGuess+"|"+req.ID+"|"+strconvFormatInt(req.Exp))
	ok := equalHMAC(signGuess, req.Token)

	w.Header().Set("Content-Type", "application/json")
	_ = json.NewEncoder(w).Encode(map[string]bool{"correct": ok})
}

// helper: ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏™‡∏∞‡∏Å‡∏î/‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Unicode ‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏•‡∏≤‡∏î)
func normalizeThai(s string) string {
	s = strings.TrimSpace(s)
	s = strings.ReplaceAll(s, "  ", " ")
	return s
}

func strconvFormatInt(v int64) string {
	return strconv.FormatInt(v, 10)
}

// ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏±‡πâ‡∏á easy+hard) ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å token
func allAnswers() []string {
	out := make([]string, 0, len(quizzesEasy)+len(quizzesHard))
	for _, q := range quizzesEasy {
		out = append(out, q.Answer)
	}
	for _, q := range quizzesHard {
		out = append(out, q.Answer)
	}
	return out
}

type RevealReq struct {
	ID    string `json:"id"`
	Token string `json:"token"`
	Exp   int64  `json:"exp"`
}

func RevealQuiz(w http.ResponseWriter, r *http.Request) {
	var req RevealReq
	if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
		http.Error(w, "bad request", http.StatusBadRequest)
		return
	}

	// ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏¢
	if time.Now().Unix() < req.Exp { // üëà ‡πÉ‡∏ä‡πâ < ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ <=
		w.Header().Set("Content-Type", "application/json")
		_ = json.NewEncoder(w).Encode(map[string]any{
			"answer": "",
			"error":  "not_expired",
		})
		return
	}

	secret := getSecret()
	var found string
	for _, a := range allAnswers() {
		if equalHMAC(sign(secret, a+"|"+req.ID+"|"+strconvFormatInt(req.Exp)), req.Token) {
			found = a
			break
		}
	}

	w.Header().Set("Content-Type", "application/json")
	_ = json.NewEncoder(w).Encode(map[string]any{"answer": found})
}
